name: Deploy to Unraid

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
    branches: [ main ]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Deploy Updated Services
        run: |
          echo "ğŸ”„ Working directory: $(pwd)"
          echo "ğŸ”„ Available files:"
          ls -la
          
          # Copy .env file to current location for relative access
          cp /mnt/user/appdata/docker-compose/.env .
          
          echo "ğŸ” Checking for recently modified compose files..."
          find services -name "docker-compose.yml" -type f | while read file; do
            echo "ğŸš€ Restarting service: $(dirname "$file")"
            
            # Calculate relative path to .env from service directory
            service_dir="$(dirname "$file")"
            depth=$(echo "$service_dir" | tr -cd '/' | wc -c)
            env_path=""
            for i in $(seq 1 $depth); do
              env_path="../$env_path"
            done
            env_path="${env_path}.env"
            
            cd "$service_dir"
            docker-compose --env-file "$env_path" pull
            docker-compose --env-file "$env_path" up -d
            echo "âœ… $(basename $(dirname "$file")) updated successfully"
            cd "$GITHUB_WORKSPACE"
          done
          
          echo "ğŸ§¹ Cleaning up unused images..."
          docker image prune -f
          
          echo "ğŸ‰ Deployment completed!"
