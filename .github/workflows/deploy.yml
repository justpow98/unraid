name: Deploy to Unraid

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
    branches: [ main ]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Deploy Updated Services
        run: |
          echo "üîÑ Working directory: $(pwd)"
          echo "üîÑ Available files:"
          ls -la
          
          # Copy .env file to current location for relative access
          # .env file should be mounted directly to workspace root
          if [ -f "/workspace/.env" ]; then
            echo "‚úÖ Found .env file at /workspace/.env"
            cp /workspace/.env .
          else
            echo "‚ùå .env file not found at /workspace/.env"
            echo "üìÅ Contents of /workspace:"
            ls -la /workspace/ 2>/dev/null || echo "Cannot access /workspace"
            exit 1
          fi
          
          echo "üîç Checking for recently modified compose files..."
          find services -name "docker-compose.yml" -type f | while read file; do
            echo "üöÄ Restarting service: $(dirname "$file")"
            
            # Calculate relative path to .env from service directory
            service_dir="$(dirname "$file")"
            depth=$(echo "$service_dir" | tr -cd '/' | wc -c)
            env_path=""
            for i in $(seq 1 $depth); do
              env_path="../$env_path"
            done
            env_path="${env_path}.env"
            
            cd "$service_dir"
            docker-compose --env-file "$env_path" pull
            docker-compose --env-file "$env_path" up -d
            echo "‚úÖ $(basename $(dirname "$file")) updated successfully"
            cd "$GITHUB_WORKSPACE"
          done
          
          echo "üßπ Cleaning up unused images..."
          docker image prune -f
          
          echo "üéâ Deployment completed!"
