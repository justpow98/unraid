name: Deploy to Unraid

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
    branches: [ main ]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Deploy Updated Services
        run: |
          echo "ğŸ”„ Working directory: $(pwd)"
          echo "ğŸ”„ Available files:"
          ls -la
          
          echo "ğŸ” Checking for recently modified compose files..."
          find services -name "docker-compose.yml" -type f | while read file; do
            echo "ğŸš€ Restarting service: $(dirname "$file")"
            
            # Go to the service directory relative to current location
            cd "$(dirname "$file")"
            
            # Use absolute path to .env file
            docker-compose --env-file /mnt/user/appdata/docker-compose/.env pull
            docker-compose --env-file /mnt/user/appdata/docker-compose/.env up -d
            
            echo "âœ… $(basename $(dirname "$file")) updated successfully"
            
            # Return to original directory
            cd "$GITHUB_WORKSPACE"
          done
          
          echo "ğŸ§¹ Cleaning up unused images..."
          docker image prune -f
          
          echo "ğŸ‰ Deployment completed!"
