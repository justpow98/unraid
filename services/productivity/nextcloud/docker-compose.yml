version: '3.8'

services:
  nextcloud:
    image: nextcloud:31.0.7
    container_name: Nextcloud
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - HOST_OS=Unraid
      - HOST_HOSTNAME=JP-Dell
      - HOST_CONTAINERNAME=Nextcloud
      - POSTGRES_HOST=nextcloud-postgres
      - POSTGRES_DB=${NEXTCLOUD_DB_NAME}
      - POSTGRES_USER=${NEXTCLOUD_DB_USER}
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.azuleluna.xyz
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=nextcloud.azuleluna.xyz
    volumes:
      - ${APPDATA_PATH}/nextcloud:/var/www/html
      - /mnt/user/nextcloud_data:/var/www/html/data
    ports:
      - "8666:80"
    networks:
      - internal_net
      - db_net
    depends_on:
      - nextcloud-postgres

  nextcloud-postgres:
    image: postgres:17.2
    container_name: Nextcloud-PostGres
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - HOST_OS=Unraid
      - HOST_HOSTNAME=JP-Dell
      - HOST_CONTAINERNAME=Nextcloud-PostGres
      - POSTGRES_DB=${NEXTCLOUD_DB_NAME}
      - POSTGRES_USER=${NEXTCLOUD_DB_USER}
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
    volumes:
      - ${APPDATA_PATH}/nextcloud/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - db_net

networks:
  internal_net:
    external: true
  db_net:
    external: true