name: Deploy to Unraid

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
    branches: [ main ]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: [self-hosted, docker-compose]  # Target your specific runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Deploy to Unraid (Direct Access)
        run: |
          echo "ðŸ”„ Navigating to workspace..."
          cd /workspace
          
          echo "ðŸ”„ Pulling latest changes..."
          git pull origin main
          
          echo "ðŸ” Checking for updated services..."
          find services -name "docker-compose.yml" -newer .git/FETCH_HEAD 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              service_dir=$(dirname "$file")
              service_name=$(basename "$service_dir")
              echo "ðŸš€ Deploying updated service: $service_name"
              
              cd "$service_dir"
              docker-compose --env-file ../../../.env pull
              docker-compose --env-file ../../../.env up -d
              echo "âœ… $service_name deployed successfully"
              cd /workspace
            fi
          done
          
          echo "ðŸ§¹ Cleaning up unused images..."
          docker image prune -f
          
          echo "ðŸŽ‰ Deployment completed!"
